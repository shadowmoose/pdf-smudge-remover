<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Extractor</title>
    <link rel="icon" type="image/svg" href="./favicon.svg">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #25282f;
            color: #fff;
        }
        h1 {
            font-size: 24px;
        }
        hr {
            margin: 20px 0;
        }
        #output p {
            margin: 0;
        }
        a {
            color: #4ea1f3;
        }
    </style>
</head>

<body>
    <h1>PDF to text mass-conversion tool</h1>
    <b>Select PDF File(s):</b> <input type="file" name="files" id="fileInput" accept=".pdf" multiple />
    <br />
    <br />
    <button type="button" id="downloadButton" disabled>Download as Text</button>
    <p id="status"></p>
    <hr />
    <div
        id="output"
        style="max-height: 400px; overflow-y: auto; white-space: pre; font-family: monospace"
    ></div>
</body>

<script type="module">
    // noinspection JSFileReferences
    import { downloadZip } from "https://cdn.jsdelivr.net/npm/client-zip@2.5.0/index.js";
    import { PDFParse } from 'https://cdn.jsdelivr.net/npm/pdf-parse@2.4.5/dist/pdf-parse/web/pdf-parse.es.js';
    const input = document.getElementById('fileInput');
    const output = document.getElementById('output');
    const status = document.getElementById('status');
    const downloadButton = document.getElementById('downloadButton');
    let files = [];
    let failures = 0;

    PDFParse.setWorker('https://cdn.jsdelivr.net/npm/pdf-parse@2.4.5/dist/pdf-parse/web/pdf.worker.min.mjs');

    function log(...msg) {
        const p = document.createElement('p');
        p.textContent = msg.join(' ');
        output.appendChild(p);
        if (output.children.length > 200) {
            output.children[0].remove();
        }
        p.scrollIntoView(false);
    }

    async function parsePDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const parser = new PDFParse({ data: arrayBuffer });
        const result = await parser.getText();
        await parser.destroy();
        return result.text;
    }

    async function* getFilesText() {
        let idx=0;
        for (const file of files) {
            try {
                status.textContent = (`Processing file [${ ++idx }/${ files.length }]: ${ file.name }`);
                const text = await parsePDF(file);
                yield {
                    name: file.name + '.txt',
                    lastModified: new Date(),
                    input: text,
                }
            } catch (err) {
                log(`Error processing file: ${ file.name }:`, err.message || err);
                failures++;
            }
        }
    }

    input.addEventListener('change', async (event) => {
        files = event.target.files;
        log("Files selected:", files.length.toLocaleString());
        downloadButton.disabled = files.length <= 0;
    });
    downloadButton.addEventListener('click', async () => {
        log('Beginning text extraction...');
        failures = 0;
        const blob = await downloadZip(getFilesText()).blob();

        log('Finished processing all files. Preparing download...');
        // make and click a temporary link to download the Blob
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.click();
        link.innerText = "Download";
        status.innerText = 'Finished: ';
        status.append(link);
        log(`Finished. ${failures ? failures.toLocaleString() + ' files failed.' : 'All files processed successfully.'}`);
    });

    log('Ready. Select PDF files to attempt text extraction.');
</script>
</html>